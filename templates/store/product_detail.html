{% extends "store/base.html" %}

{% block title %}Product Details - Fit Sports Hub{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <nav class="text-sm mb-6">
        <ol class="list-none p-0 inline-flex">
            <li class="flex items-center">
                <a href="/store" class="text-blue-600 hover:text-blue-800">Home</a>
                <svg class="fill-current w-3 h-3 mx-3" viewBox="0 0 320 512">
                    <path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/>
                </svg>
            </li>
            <li class="flex items-center">
                <a href="/store/products" class="text-blue-600 hover:text-blue-800">Products</a>
                <svg class="fill-current w-3 h-3 mx-3" viewBox="0 0 320 512">
                    <path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/>
                </svg>
            </li>
            <li>
                <span class="text-gray-600" id="product-breadcrumb">Loading...</span>
            </li>
        </ol>
    </nav>

    <div id="product-detail" class="bg-white rounded-lg shadow-lg p-8">
        <!-- Product details will be loaded here -->
        <div class="text-center py-12">
            <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-gray-600 bg-white">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading product details...
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const productId = {{ product_id }};

function loadProductDetails() {
    console.log('Loading product details for ID:', productId);
    
    // First try to get from the products list endpoint
    fetch('/api/store/products')
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Products data received:', data);
            // Find the specific product from the list
            let product = null;
            
            if (data.items && Array.isArray(data.items)) {
                product = data.items.find(p => p.id === productId);
            } else if (Array.isArray(data)) {
                product = data.find(p => p.id === productId);
            }
            
            if (product) {
                console.log('Product found:', product);
                // Update breadcrumb
                document.getElementById('product-breadcrumb').textContent = product.name;
                // Update page title
                document.title = `${product.name} - Fit Sports Hub`;
                renderProductDetails(product);
            } else {
                throw new Error('Product not found');
            }
        })
        .catch(error => {
            console.error('Error loading product:', error);
            // Try the individual product endpoint as fallback
            return fetch(`/api/store/product/${productId}`)
                .then(response => response.json())
                .then(product => {
                    renderProductDetails(product);
                })
                .catch(fallbackError => {
                    console.error('Fallback error:', fallbackError);
                    document.getElementById('product-detail').innerHTML = `
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 text-red-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-red-600 text-lg font-medium">Error loading product details</p>
                            <p class="text-gray-500 mt-2">Please try again later or <a href="/store/products" class="text-blue-600 hover:text-blue-800">browse other products</a></p>
                        </div>
                    `;
                });
        });
}

function renderProductDetails(product) {
    const container = document.getElementById('product-detail');
    
    // Handle the data format from the store API
    const hasImages = product.images && product.images.length > 0;
    const price = product.price || 0;
    const stockQuantity = product.stock_quantity || product.stock || 0;
    const isAvailable = stockQuantity > 0;
    const category = product.category || {};
    
    let imagesHtml = '';
    if (hasImages) {
        // Images are already URLs in the store API response
        const images = product.images.map(img => {
            if (typeof img === 'string') {
                return { url: img };
            }
            return { url: img.url || img };
        });
        
        imagesHtml = `
            <div class="space-y-4">
                <img id="main-image" 
                     src="${images[0].url}" 
                     alt="${product.name}" 
                     class="w-full h-96 object-cover rounded-lg"
                     onerror="this.src='/static/img/placeholder.png'">
                ${images.length > 1 ? `
                    <div class="grid grid-cols-4 gap-2">
                        ${images.map((img, index) => `
                            <img src="${img.url}" 
                                 alt="${product.name}" 
                                 class="w-full h-24 object-cover rounded cursor-pointer hover:opacity-75 transition-opacity ${index === 0 ? 'ring-2 ring-blue-500' : ''}"
                                 onclick="changeMainImage('${img.url}', this)"
                                 onerror="this.src='/static/img/placeholder.png'">
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    } else {
        imagesHtml = `<img src="/static/img/placeholder.png" alt="${product.name}" class="w-full h-96 object-cover rounded-lg">`;
    }
    
    container.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Images -->
            <div>
                ${imagesHtml}
            </div>
            
            <!-- Product Info -->
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-4">${product.name || 'Product Name'}</h1>
                
                <div class="flex items-center gap-4 mb-6">
                    <span class="text-4xl font-bold text-blue-600">$${parseFloat(price).toFixed(2)}</span>
                    ${isAvailable 
                        ? `<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">In Stock (${stockQuantity} available)</span>`
                        : '<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">Out of Stock</span>'
                    }
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">Description</h3>
                    <p class="text-gray-600">${product.description || 'No description available.'}</p>
                </div>
                
                ${category.name ? `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">Category</h3>
                        <a href="/store/products?category=${category.id}" class="text-blue-600 hover:text-blue-800">
                            ${category.name}
                        </a>
                    </div>
                ` : ''}
                
                <!-- Add to Cart -->
                <div class="border-t pt-6">
                    <div class="flex items-center gap-4 mb-6">
                        <label class="font-semibold">Quantity:</label>
                        <div class="flex items-center border rounded-lg">
                            <button onclick="decreaseQuantity()" class="px-3 py-2 hover:bg-gray-100">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                </svg>
                            </button>
                            <input type="number" 
                                   id="quantity" 
                                   value="1" 
                                   min="1" 
                                   max="${stockQuantity || 1}"
                                   class="w-16 text-center border-0 focus:ring-0">
                            <button onclick="increaseQuantity(${stockQuantity || 1})" class="px-3 py-2 hover:bg-gray-100">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <button onclick="addProductToCart()" 
                            class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold ${!isAvailable ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${!isAvailable ? 'disabled' : ''}>
                        ${isAvailable ? 'Add to Cart' : 'Out of Stock'}
                    </button>
                </div>
                
                <!-- Product Features -->
                <div class="mt-8 bg-gray-50 rounded-lg p-6">
                    <h3 class="font-semibold mb-4">Why Choose This Product?</h3>
                    <ul class="space-y-2">
                        <li class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span>Premium quality materials</span>
                        </li>
                        <li class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span>30-day money back guarantee</span>
                        </li>
                        <li class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span>Free shipping on orders over $50</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    `;
}

function changeMainImage(url, thumbnail) {
    document.getElementById('main-image').src = url;
    
    // Update active thumbnail
    document.querySelectorAll('.grid img').forEach(img => {
        img.classList.remove('ring-2', 'ring-blue-500');
    });
    thumbnail.classList.add('ring-2', 'ring-blue-500');
}

function increaseQuantity(max) {
    const input = document.getElementById('quantity');
    const current = parseInt(input.value);
    if (current < max) {
        input.value = current + 1;
    }
}

function decreaseQuantity() {
    const input = document.getElementById('quantity');
    const current = parseInt(input.value);
    if (current > 1) {
        input.value = current - 1;
    }
}

function addProductToCart() {
    const quantity = parseInt(document.getElementById('quantity').value);
    addToCart(productId, quantity);
}

// Load product details on page load
document.addEventListener('DOMContentLoaded', function() {
    loadProductDetails();
});
</script>
{% endblock %}
